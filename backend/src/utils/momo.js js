const axios = require('axios');
const crypto = require('crypto');

exports.createMomoUrl = async (orderCode, amount) => {
  const partnerCode = process.env.MOMO_PARTNER_CODE || 'MOMO';
  const accessKey = process.env.MOMO_ACCESS_KEY || 'key';
  const secretKey = process.env.MOMO_SECRET_KEY || 'secret';
  const returnUrl = `${process.env.FRONTEND_URL}/checkout/result`;
  const notifyUrl = `${process.env.FRONTEND_URL}/api/payment/momo/notify`;
  const requestId = partnerCode + Date.now();
  const orderId = orderCode;
  const orderInfo = `Thanh toan don hang ${orderCode}`;
  const requestType = 'payWithATM';
  const extraData = '';

  const rawSignature = `accessKey=${accessKey}&amount=${amount}&extraData=${extraData}&ipnUrl=${notifyUrl}&orderId=${orderId}&orderInfo=${orderInfo}&partnerCode=${partnerCode}&redirectUrl=${returnUrl}&requestId=${requestId}&requestType=${requestType}`;
  const signature = crypto.createHmac('sha256', secretKey).update(rawSignature).digest('hex');

  const body = { partnerCode, accessKey, requestId, amount, orderId, orderInfo, returnUrl, notifyUrl: notifyUrl, extraData, requestType, signature, lang: 'vi' };

  const response = await axios.post(`${process.env.MOMO_ENDPOINT || 'https://test-payment.momo.vn'}/v2/gateway/api/create`, body);
  return response.data;
};
